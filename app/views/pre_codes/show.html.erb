<!-- =========================================================
  Page: PreCode 詳細画面（自分のデータ）
  ---------------------------------------------------------
  ・登録名 / タグ / 説明 / コード / 解答（問題モード時）を表示
  ・XシェアやURLコピーの導線あり
  ・右下に編集/削除リンク
========================================================= -->

<!-- 実務上の nil ケア：@code が入ってくる場合の受け口を確保 -->
<% @pre_code ||= @code %>

<!-- =======================
     パンくずナビ
======================= -->
<% breadcrumb :pre_codes %>
<% breadcrumb :pre_code, @pre_code %>
<%= render "shared/breadcrumbs" %>

<!-- =======================
     ページ <title>
======================= -->
<% content_for :title, @pre_code.title %>

<div class="mx-auto w-full max-w-2xl space-y-8">

  <!-- =======================
       右上：Xシェア＆URLコピー
       data-controller="share" に現在ページURLを渡す
======================= -->
  <div class="flex justify-end gap-2 mb-2"
      data-controller="share"
      data-share-url-value="<%= code_library_url(@pre_code) %>">
    <button type="button"
            data-action="share#openTwitter"
            data-text="<%= "#{@pre_code.title} をシェア #RailsLearning #Ruby #Rails" %>"
            class="btn-dark">
      Xでシェア
    </button>

    <button type="button"
            data-action="share#copy"
            class="btn-dark">
      URLコピー
    </button>
  </div>

  <!-- =======================
       登録名
======================= -->
  <section>
    <h2 class="text-sm font-semibold tracking-wider text-slate-500">登録名</h2>
    <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3">
      <p class="text-base"><%= @pre_code.title %></p>
    </div>
  </section>

  <!-- =======================
       タグ
       ※ ネストされたリンク事故を避けるため、静的ピルを使用
======================= -->
  <section>
    <h2 class="text-sm font-semibold tracking-wider text-slate-500">タグ</h2>
    <div class="mt-1 flex flex-wrap">
      <%= render "shared/tag_pills_static", record: @pre_code %>
    </div>
  </section>

  <!-- =======================
       コードの説明
======================= -->
  <section>
    <h2 class="text-sm font-semibold tracking-wider text-slate-500">コードの説明</h2>
    <div class="mt-1 rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3">
      <%= simple_format @pre_code.description %>
    </div>
  </section>

  <!-- =======================
       ヒント（問題モードの場合に出現）
======================= -->
  <% if @pre_code.hint.present? %>
    <section data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h2 class="text-sm font-semibold tracking-wider text-slate-500">ヒント</h2>
        <button type="button" class="btn-toggle"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>

      <!-- reveal で開閉される本文（HTMLは sanitize で許可リスト制御） -->
      <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
          data-reveal-target="content">
        <%= sanitize(@pre_code.hint,
                    tags: %w[b i em strong code pre br p ul ol li a],
                    attributes: %w[href]) %>
      </div>
    </section>
  <% end %>

  <!-- =======================
       登録コード + 最終更新
       CodeMirror（閲覧専用）で見やすく表示
======================= -->
  <section>
    <div class="flex items-baseline justify-between">
      <h2 class="text-sm font-semibold tracking-wider text-slate-500">登録コード</h2>
      <p class="text-xs text-slate-500">
        最終更新日：<%= l @pre_code.updated_at.in_time_zone, format: :ymd_hm %>
      </p>
    </div>

    <!-- CodeMirror（閲覧専用テーマ） -->
    <style>
      .cm-editor, .cm-scroller { background: transparent !important; }
    </style>
    <div
      data-controller="code-view"
      data-code-view-theme-value="light"
      class="mt-1 rounded-xl ring-1 ring-slate-300 overflow-hidden"
    >
      <textarea data-code-view-target="field" class="hidden"><%= @pre_code.body %></textarea>
      <div data-code-view-target="mount" class="w-full min-h-[120px]"></div>
    </div>
  </section>

  <!-- =======================
       解答（問題モードで answer/answer_code が存在する場合）
       ・本文（HTML許可リスト）
       ・解答コード（CodeMirror）
======================= -->
  <% if @pre_code.answer.present? || @pre_code.answer_code.present? %>
    <section data-controller="reveal" class="space-y-2">
      <div class="flex items-baseline justify-between">
        <h2 class="text-sm font-semibold tracking-wider text-slate-500">解答</h2>
        <button type="button" class="btn-toggle"
                data-reveal-target="button" data-action="reveal#toggle">表示する</button>
      </div>

      <% if @pre_code.answer.present? %>
        <div class="hidden rounded-xl ring-1 ring-slate-300 bg-white px-4 py-3"
            data-reveal-target="content">
          <%= sanitize(@pre_code.answer,
                      tags: %w[b i em strong code pre br p ul ol li a],
                      attributes: %w[href]) %>
        </div>
      <% end %>

      <% if @pre_code.answer_code.present? %>
        <div class="hidden" data-reveal-target="content">
          <style>.cm-editor,.cm-scroller{background:transparent!important}</style>
          <div data-controller="code-view" data-code-view-theme-value="light"
              class="rounded-xl ring-1 ring-slate-300 overflow-hidden">
            <textarea data-code-view-target="field" class="hidden"><%= @pre_code.answer_code %></textarea>
            <div data-code-view-target="mount" class="w-full min-h-[120px]"></div>
          </div>
        </div>
      <% end %>
    </section>
  <% end %>

  <!-- =======================
       利用ボタン（エディタ画面へ遷移）
       ※ Code Library 側の「このデータを利用する」（カウントあり）と差別化して、ここはシンプル導線
======================= -->
  <section class="-mt-2">
    <div class="items-center flex justify-center">
      <%= link_to "このデータを利用する",
                  editor_path(pre_code_id: @pre_code.id),
                  class: "btn-solid-red--wide" %>
    </div>
  </section>

  <!-- =======================
       右下：編集/削除アクション
======================= -->
  <div class="-mt-2 flex justify-end space-x-3">
    <%= link_to "編集", edit_pre_code_path(@pre_code),
          class: "btn-change is-edit" %>
    <%= link_to "削除", @pre_code,
          data: { turbo_method: :delete, turbo_confirm: "削除しますか？" },
          class: "btn-change is-delete" %>
  </div>
</div>
