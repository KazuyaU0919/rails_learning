<!-- =========================================================
  Partial: Google Analytics (gtag.js)
  File: app/views/shared/_google_analytics.html.erb
  ---------------------------------------------------------
  目的：
    ・GA_MEASUREMENT_ID が設定されている本番環境でのみ、
      Google Analytics（GA4）を自動埋め込み。
  備考：
    ・SPA / Turbo に対応するため page_view は手動送信。
    ・CSP対応：nonce属性を付与。
========================================================= -->

<!-- =======================
     本番かつ GA_MEASUREMENT_ID が存在する場合のみ
======================= -->
<% if Rails.env.production? && ENV["GA_MEASUREMENT_ID"].present? %>
  <% ga_id = ENV["GA_MEASUREMENT_ID"] %>

  <!-- =======================
       gtag.js 読み込みスクリプト
  ======================= -->
  <script async
          src="https://www.googletagmanager.com/gtag/js?id=<%= ERB::Util.url_encode(ga_id) %>"
          nonce="<%= content_security_policy_nonce %>"></script>

  <!-- =======================
       初期化スクリプト
       - dataLayer の準備
       - 自動 page_view をOFF
       - Turbo対応 page_view送信関数
  ======================= -->
  <script nonce="<%= content_security_policy_nonce %>">
    // dataLayer 初期化
    window.dataLayer = window.dataLayer || [];
    function gtag(){ dataLayer.push(arguments); }

    // 初期設定
    gtag('js', new Date());
    gtag('config', '<%= ga_id %>', { 'send_page_view': false });

    // ページ表示イベント送信用関数
    function sendPageView() {
      gtag('event', 'page_view', {
        page_title:   document.title,
        page_location: location.href,
        page_path:     location.pathname + location.search
      });
    }

    // Turbo利用時：turbo:loadごとに送信
    document.addEventListener('turbo:load', sendPageView);

    // Turbo未使用環境では DOMContentLoaded に対応
    if (!window.Turbo) {
      document.addEventListener('DOMContentLoaded', sendPageView);
    }
  </script>
<% end %>
