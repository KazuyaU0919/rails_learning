# =========================================================
# File: config/deploy.yml
# ---------------------------------------------------------
# 目的:
#   Kamal (旧名: Kamal/SSHKit 由来の最小構成デプロイ) のデプロイ設定。
#   コンテナイメージ・接続先・プロキシ・レジストリ・ENV・ボリュームなどを宣言。
#
# ガイド:
#   - service / image … アプリ識別子とビルドするイメージ名。
#   - servers … web/job の各ロールを割り当て。単一ホストの最小構成例。
#   - proxy … 単一 Web サーバー構成での SSL/TLS とホスト名を指定。
#   - registry … プライベートレジストリ利用時の資格情報を指定。
#   - env … RAILS_MASTER_KEY 等のシークレット/明文環境変数を注入。
#   - aliases … よく使う操作を短縮（rails console, shell, logs, dbconsole）。
#   - volumes … 永続化が必要なパスをボリュームにマウント。
#   - asset_path … フィンガープリント済みアセットのブリッジ。
#   - builder … ビルドアーキテクチャ等のビルダー設定。
# =========================================================

# =======================
# アプリ識別
# =======================
service: rails_learning            # コンテナ群を一意に識別

# =======================
# コンテナイメージ
# =======================
image: your-user/rails_learning

# =======================
# デプロイ先サーバ
# =======================
servers:
  web:
    - 192.168.0.1
  # job:
  #   hosts:
  #     - 192.168.0.1
  #   cmd: bin/jobs

# =======================
# プロキシ/SSL（単一 Web サーバー運用例）
# =======================
# Let's Encrypt による自動証明書発行を有効化する簡易構成。
# 複数 Web サーバでの運用時はロードバランサ側で終端し、この設定は削除する。
#
# Cloudflare 利用時は、ダッシュボードの SSL/TLS 設定で "Full" を選択。
proxy:
  ssl: true
  host: app.example.com

# =======================
# イメージレジストリ認証
# =======================
registry:
  # server: registry.digitalocean.com / ghcr.io / ...  # Docker Hub 以外を使う場合は指定
  username: your-user
  password:
    - KAMAL_REGISTRY_PASSWORD      # 可能な限りアクセストークンを使用（生パスワード非推奨）

# =======================
# 環境変数注入（.kamal/secrets から取り込み）
# =======================
env:
  secret:
    - RAILS_MASTER_KEY
  clear:
    # Web サーバの Puma プロセス内で Solid Queue Supervisor を動かす（単一ホスト向け）
    SOLID_QUEUE_IN_PUMA: true

    # 例: Solid Queue の並列数
    # JOB_CONCURRENCY: 3

    # 例: Web の並列プロセス数
    # WEB_CONCURRENCY: 2

    # 例: 外部 DB を使う場合のホスト指定
    # DB_HOST: 192.168.0.2

    # 例: ログレベルを詳細化
    # RAILS_LOG_LEVEL: debug

# =======================
# よく使うエイリアス
# =======================
aliases:
  console: app exec --interactive --reuse "bin/rails console"
  shell:   app exec --interactive --reuse "bash"
  logs:    app logs -f
  dbc:     app exec --interactive --reuse "bin/rails dbconsole"

# =======================
# 永続ボリューム
# =======================
# Active Storage（ローカル保存）や sqlite を使う場合の例。
# バックアップ対象の外部ストレージにマウントするのが望ましい。
volumes:
  - "rails_learning_storage:/rails/storage"

# =======================
# アセットブリッジ
# =======================
# フィンガープリント済みアセットの入替時に 404 を避けるため、
# 旧/新の assets を合成して提供する。
asset_path: /rails/public/assets

# =======================
# ビルダー設定
# =======================
builder:
  arch: amd64
  # remote: ssh://docker@docker-builder-server
  # args:
  #   RUBY_VERSION: 3.4.1
  # secrets:
  #   - GITHUB_TOKEN
  #   - RAILS_MASTER_KEY

# =======================
# SSH（必要に応じて）
# =======================
# ssh:
#   user: app

# =======================
# アクセサリサービス（例: DB/Redis）
# =======================
# accessories:
#   db:
#     image: mysql:8.0
#     host: 192.168.0.2
#     port: "127.0.0.1:3306:3306"       # 公開するなら 3306 のみ
#     env:
#       clear:
#         MYSQL_ROOT_HOST: '%'
#       secret:
#         - MYSQL_ROOT_PASSWORD
#     files:
#       - config/mysql/production.cnf:/etc/mysql/my.cnf
#       - db/production.sql:/docker-entrypoint-initdb.d/setup.sql
#     directories:
#       - data:/var/lib/mysql
#   redis:
#     image: redis:7.0
#     host: 192.168.0.2
#     port: 6379
#     directories:
#       - data:/data
