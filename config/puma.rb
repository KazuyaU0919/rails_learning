# =========================================================
# File: config/puma.rb
# ---------------------------------------------------------
# 目的:
#   Puma（Rails標準のマルチスレッドWebサーバ）の設定。
#   スレッド数・ポート・再起動設定・Solid Queue統合などを指定。
#
# 運用ポイント:
#   - スレッド数: IO待ち時間が長い場合は増やすとスループット向上。
#   - PORT: 環境変数 PORT（デフォルト3000）を使用。
#   - plugin :tmp_restart により bin/rails restart が有効。
# =========================================================

# =======================
# スレッド数の設定
# =======================
# 各ワーカーで使用するスレッド数を指定。
# IO待機時間とスループットのバランスを考慮して3を基準とする。
threads_count = ENV.fetch("RAILS_MAX_THREADS", 3)
threads threads_count, threads_count

# =======================
# ポート設定
# =======================
# デフォルトは 3000 番ポート。
port ENV.fetch("PORT", 3000)

# =======================
# 再起動設定
# =======================
# `bin/rails restart` コマンドで安全に再起動できるようにする。
plugin :tmp_restart

# =======================
# Solid Queue連携
# =======================
# 単一サーバ構成ではPuma内でSolid Queue Supervisorを実行する。
plugin :solid_queue if ENV["SOLID_QUEUE_IN_PUMA"]

# =======================
# PIDファイル設定
# =======================
# 環境変数 PIDFILE が設定されていれば利用。
pidfile ENV["PIDFILE"] if ENV["PIDFILE"]
